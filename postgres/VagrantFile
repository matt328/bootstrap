Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"

  # Network
  
  # Optional: static IP
  config.vm.network "public_network", ip: "192.168.50.155", bridge: "Intel(R) Ethernet Connection (22) I219-LM"

  # Provision Postgres
  config.vm.provision "shell",
  env: {
    "DB_NAME" => ENV["DB_NAME"] || "mydb",
    "DB_USER" => ENV["DB_USER"] || "myuser",
    "DB_PASS" => ENV["DB_PASS"] || "mypassword"
  },
  inline: <<-SHELL
    set -e

    echo "[+] Updating apt..."
    sudo apt-get update -y

    echo "[+] Installing Postgres..."
    sudo apt-get install -y postgresql postgresql-contrib

    # Set up DB, user, password
    DB_NAME="${DB_NAME:-mydb}"
    DB_USER="${DB_USER:-myuser}"
    DB_PASS="${DB_PASS:-mypassword}"

    echo "[+] Configuring Postgres user and database..."
    echo "DB_USER=$DB_USER DB_PASS=$DB_PASS"
    sudo -u postgres psql <<EOSQL
      CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';
      ALTER USER $DB_USER SET search_path TO public;
      CREATE DATABASE $DB_NAME OWNER $DB_USER;
      GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
      ALTER USER $DB_USER WITH SUPERUSER;
EOSQL

    # Allow password authentication
    sudo sed -i "s/^#listen_addresses =.*/listen_addresses = '*'/" /etc/postgresql/*/main/postgresql.conf
    echo "host    all             all             0.0.0.0/0               md5" | sudo tee -a /etc/postgresql/*/main/pg_hba.conf

    sudo systemctl restart postgresql
    echo "[+] Postgres is ready!"
  SHELL
end
